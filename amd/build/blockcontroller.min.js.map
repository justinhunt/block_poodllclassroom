{"version":3,"file":"blockcontroller.min.js","sources":["../src/blockcontroller.js"],"sourcesContent":["define(['jquery','core/config','core/log','core/ajax','core/templates','core/modal_factory','core/str','core/modal_events',\n    'block_poodllclassroom/dialogs','block_poodllclassroom/datatables','block_poodllclassroom/modalformhelper',\n        'block_poodllclassroom/modaldeletehelper','core/notification'],\n    function($,cfg,log,Ajax, templates, ModalFactory, str,\n             ModalEvents,  dialogs, datatables, mfh, mdh, notification) {\n    \"use strict\"; // jshint ;_;\n\n    log.debug('blockcontroller: initialising');\n\n    return {\n        controls: {},\n        modulecssclass: null,\n        contextid: 0,\n        strings: [],\n        subinfo: {},\n\n\n        init: function(props){\n            //pick up opts from html\n            var optscontrol = $('#' + props.id).get(0);\n            if (optscontrol) {\n                var opts = JSON.parse(optscontrol.value);\n                $(optscontrol).remove();\n            } else {\n                //if there is no config we might as well give up\n                log.debug('Poodll classroom Controller: No config found on page. Giving up.');\n                return;\n            }\n\n            this.modulecssclass = opts.modulecssclass;\n            this.contextid = opts.contextid;\n            this.tableid = opts.tableid;\n            this.subinfo = opts.subinfo;\n            this.schoolplan = opts.schoolplan;\n            this.prepare_html();\n            this.register_events();\n            this.check_user_count();\n            this.check_course_count();\n        },\n\n        init_strings: function(){\n            var that = this;\n           var strings=['createcourse'];\n           for(var i=0; i<strings.length; i++) {\n               str.get_string(strings[i],'block_poodllclassroom').then(function (stringdata) {\n                   that.strings[i]=stringdata;\n               });\n           }\n        },\n\n        prepare_html: function(){\n            this.controls.createuserstartbutton = $('#' + this.modulecssclass + '_createuser_btn');\n            this.controls.uploaduserstartbutton = $('#' + this.modulecssclass + '_uploaduser_btn');\n            this.controls.createcoursestartbutton = $('#' + this.modulecssclass + '_createcourse_btn');\n            this.controls.createcoursestartcontainer = $('#' + this.modulecssclass +'_createcourse_cnt');\n            this.controls.nocoursescontainer = $('.' + this.modulecssclass + '_nocourses_cont');\n            this.controls.coursescontainer = $('.' + this.modulecssclass + '_courselist_cont');\n            this.controls.nouserscontainer = $('.' + this.modulecssclass + '_nousers_cont');\n            this.controls.userscontainer = $('.' + this.modulecssclass + '_userlist_cont');\n            this.controls.theusertable = datatables.getDataTable(this.tableid);\n            this.controls.createcoursestartbutton.show();\n            log.debug(this.controls);\n\n        },\n\n        register_events: function(){\n            var that =this;\n            //modal form helper\n            var after_useradd= function(item, itemid) {\n                log.debug('after user add');\n                log.debug(item);\n                item.id=itemid;\n                item.lastaccess = '--:--';\n                templates.render('block_poodllclassroom/userlistrow',item).then(\n                    function(html,js){\n                        that.controls.theusertable.row.add($(html)[0]).draw();\n                        //can we now add users where before we could not?\n                        that.check_user_count();\n                    }\n                );\n                that.controls.nouserscontainer.hide();\n                that.controls.userscontainer.show();\n\n            };\n            var after_userupload= function() {\n                log.debug('after user upload');\n                //Its cheating a bit, but lets just reload\n                document.location.reload();\n            };\n            var after_courseadd= function(item, itemid) {\n                log.debug('after course add');\n                log.debug(item);\n                item.id = itemid;\n                item.wwwroot = cfg.wwwroot;\n                item.coursename = item.fullname;\n                templates.render('block_poodllclassroom/courseitem',item).then(\n                    function(html,js){\n                        that.controls.coursescontainer.append($(html)[0]);\n                        //can we now add users where before we could not?\n                        that.check_course_count();\n                    }\n                );\n\n                that.controls.nocoursescontainer.addClass('block_poodllclassroom_hidden');\n                that.controls.coursescontainer.removeClass('block_poodllclassroom_hidden');\n\n            };\n            var after_useredit= function(item, itemid) {\n                var therow = '#' + that.modulecssclass + '_user_row_' + itemid;\n                //c0 = firstname c1= lastname c2=lastaccess\n                that.controls.theusertable.cell($(therow + ' .c0')).data(item.firstname);\n                that.controls.theusertable.cell($(therow + ' .c1')).data(item.lastname);\n            };\n            var after_courseedit= function(item, itemid) {\n                var tileselector = '#' + that.modulecssclass + '_courseitem_' + itemid;\n                var coursenameselector = '.' + that.modulecssclass + '_coursename';\n                $(tileselector + ' ' + coursenameselector).text(item.fullname);\n            };\n\n\n            //modal delete helper\n            var after_coursedelete= function(itemid) {\n                log.debug('after course delete');\n                $('#' + that.modulecssclass + '_courseitem_' + itemid).remove();\n                var itemcount = $('div.' + that.modulecssclass + '_courseitem').length;\n                if(!itemcount){\n                    that.controls.nocoursescontainer.removeClass('block_poodllclassroom_hidden');\n                    that.controls.coursescontainer.addClass('block_poodllclassroom_hidden');\n                }\n                //can we now add courses where before we could not?\n                that.check_course_count();\n            };\n            var after_userdelete= function(itemid) {\n                log.debug('after user delete');\n                that.controls.theusertable.row('#' + that.modulecssclass + '_user_row_' + itemid).remove().draw();\n                var itemcount = that.controls.theusertable.rows().count();\n                if(!itemcount){\n                    that.controls.nouserscontainer.show();\n                    that.controls.userscontainer.hide();\n                }\n                //can we now add users where before we could not?\n                that.check_user_count();\n            };\n\n            //form helper\n            mfh.init('#' + this.modulecssclass + '_createuser_btn', this.contextid, 'createuser',after_useradd);\n            mfh.init('#' + this.modulecssclass + '_uploaduser_btn', this.contextid, 'uploaduser',after_userupload);\n            mfh.init('#' + this.modulecssclass + '_createcourse_btn', this.contextid, 'createcourse', after_courseadd);\n            mfh.init('.' + this.modulecssclass + '_usereditlink', this.contextid, 'edituser', after_useredit);\n            mfh.init('.' + this.modulecssclass + '_courseeditlink', this.contextid, 'editcourse', after_courseedit);\n\n            //delete helper\n            mdh.init('.' + this.modulecssclass + '_coursedeletelink', this.contextid, 'deletecourse',after_coursedelete);\n            mdh.init('.' + this.modulecssclass + '_userdeletelink', this.contextid, 'deleteuser',after_userdelete);\n\n        }, //en of reg events\n\n        check_course_count: function(){\n            var coursecount = $('.' + this.modulecssclass + '_courseitem').length;\n            if(this.schoolplan.maxcourses > coursecount) {\n                this.set_enabled(this.controls.createcoursestartbutton,true);\n            }else{\n                this.set_enabled(this.controls.createcoursestartbutton,false);\n            }\n        },\n\n        check_user_count: function(){\n            var usercount = $('.' + this.modulecssclass + '_user_row').length;\n            if(this.schoolplan.maxusers > usercount) {\n                this.set_enabled(this.controls.createuserstartbutton,true);\n                this.set_enabled(this.controls.uploaduserstartbutton,true);\n            }else{\n                this.set_enabled(this.controls.createuserstartbutton,false);\n                this.set_enabled(this.controls.uploaduserstartbutton,false);\n            }\n        },\n\n        set_enabled: function (elem, enabled){\n            switch(enabled){\n                case true:\n                    elem.removeClass('disabled');\n                    elem.attr('aria-disabled','false');\n                    elem.attr('tabindex','0');\n                    break;\n                case false:\n                    elem.addClass('disabled');\n                    elem.attr('aria-disabled','true');\n                    elem.attr('tabindex','-1');\n            }\n        },\n\n        format_date: function(timestamp) {\n                var d = new Date(timestamp * 1000);\n               var month = '' + (d.getMonth() + 1),\n                day = '' + d.getDate(),\n                year = d.getFullYear();\n\n            if (month.length < 2)\n                month = '0' + month;\n            if (day.length < 2)\n                day = '0' + day;\n\n            return [year, month, day].join('-');\n        }\n    };//end of return object\n\n});"],"names":["define","$","cfg","log","Ajax","templates","ModalFactory","str","ModalEvents","dialogs","datatables","mfh","mdh","notification","debug","controls","modulecssclass","contextid","strings","subinfo","init","props","optscontrol","id","get","opts","JSON","parse","value","remove","tableid","schoolplan","prepare_html","register_events","check_user_count","check_course_count","init_strings","that","this","i","length","get_string","then","stringdata","createuserstartbutton","uploaduserstartbutton","createcoursestartbutton","createcoursestartcontainer","nocoursescontainer","coursescontainer","nouserscontainer","userscontainer","theusertable","getDataTable","show","item","itemid","lastaccess","render","html","js","row","add","draw","hide","document","location","reload","wwwroot","coursename","fullname","append","addClass","removeClass","therow","cell","data","firstname","lastname","tileselector","coursenameselector","text","rows","count","coursecount","maxcourses","set_enabled","usercount","maxusers","elem","enabled","attr","format_date","timestamp","d","Date","month","getMonth","day","getDate","year","getFullYear","join"],"mappings":"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"}