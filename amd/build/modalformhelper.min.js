/**
 * Add a create new group modal to the page.
 *
 * @module     block_poodllclassroom/modalformhelper
 * @class      modalformhelper
 * @package    block_poodllclassroom
 * @copyright  2020 Justin Hunt <poodllsupport@moodle.com>
 * @license    http://www.gnu.org/copyleft/gpl.html GNU GPL v3 or later
 */
define("block_poodllclassroom/modalformhelper",["jquery","core/log","core/str","core/modal_factory","core/modal_events","core/fragment","core/ajax","core/yui"],(function($,log,Str,ModalFactory,ModalEvents,Fragment,Ajax,Y){var TheForm=function(selector,contextid,formname,callback){this.contextid=contextid,this.formname=formname,this.callback=callback,this.preinit(selector)};return TheForm.prototype.modal=null,TheForm.prototype.contextid=-1,TheForm.prototype.itemid=-1,TheForm.prototype.formname="",TheForm.prototype.init=function(selector){var triggers=$(selector);return Str.get_string(this.formname,"block_poodllclassroom").then(function(title){return ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:title,body:this.getBody({})},triggers)}.bind(this)).then(function(modal){return this.modal=modal,this.modal.setLarge(),this.modal.getRoot().on(ModalEvents.hidden,function(){this.modal.setBody(this.getBody({}))}.bind(this)),this.modal.getRoot().on(ModalEvents.shown,function(){this.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")}.bind(this)),this.modal.getRoot().on(ModalEvents.save,this.submitForm.bind(this)),this.modal.getRoot().on("submit","form",this.submitFormAjax.bind(this)),this.modal}.bind(this))},TheForm.prototype.preinit=function(selector){$(selector);var dd=this;Str.get_string(this.formname,"block_poodllclassroom").then((function(title){dd.formtitle=title})),$("body").on("click",selector,(function(e){e.preventDefault(),dd.itemid=$(this).data("id"),ModalFactory.create({type:ModalFactory.types.SAVE_CANCEL,title:dd.formtitle,body:dd.getBody({})}).then((function(modal){return dd.modal=modal,dd.modal.setLarge(),dd.modal.getRoot().on(ModalEvents.hidden,function(){dd.modal.setBody(dd.getBody({}))}.bind(dd)),dd.modal.getRoot().on(ModalEvents.shown,(function(){dd.modal.getRoot().append("<style>[data-fieldtype=submit] { display: none ! important; }</style>")})),dd.modal.getRoot().on(ModalEvents.save,dd.submitForm.bind(dd)),dd.modal.getRoot().on("submit","form",dd.submitFormAjax.bind(dd)),dd.modal.show(),dd.modal}))}))},TheForm.prototype.getBody=function(formdata){log.debug(formdata),void 0===formdata&&(formdata={});var params={jsonformdata:JSON.stringify(formdata),formname:this.formname,itemid:this.itemid},ret=Fragment.loadFragment("block_poodllclassroom","mform",this.contextid,params);return log.debug(ret),ret},TheForm.prototype.handleFormSubmissionResponse=function(formData,ajaxresult){log.debug(ajaxresult),log.debug(formData);var payloadobject=JSON.parse(ajaxresult);if(payloadobject)if(log.debug(payloadobject),!1===payloadobject.error){this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()}));var dataobject=JSON.parse('{"'+decodeURI(formData).replace(/"/g,'\\"').replace(/&/g,'","').replace(/=/g,'":"')+'"}');this.callback(dataobject,payloadobject.itemid)}else{if("uploaduser"===this.formname){for(var thedata=formData.split("&"),usedata={},i=0;i<thedata.length;i++)if(thedata[i].includes("importdata"))usedata.importdata=payloadobject.importdata;else{var pair=thedata[i].split("=");usedata[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1])}this.modal.setBody(this.getBody(usedata)),alert(payloadobject.message)}else this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()}));log.debug("that was an error: ")}else this.modal.hide(),Y.use("moodle-core-formchangechecker",(function(){M.core_formchangechecker.reset_form_dirty_state()}))},TheForm.prototype.handleFormSubmissionFailure=function(data){this.modal.setBody(this.getBody(data))},TheForm.prototype.submitFormAjax=function(e){e.preventDefault();var changeEvent=document.createEvent("HTMLEvents");changeEvent.initEvent("change",!0,!0),this.modal.getRoot().find(":input").each((function(index,element){element.dispatchEvent(changeEvent)}));var invalid=$.merge(this.modal.getRoot().find('[aria-invalid="true"]'),this.modal.getRoot().find(".error"));if(invalid.length)invalid.first().focus();else{var formData=this.modal.getRoot().find("form").serialize();Ajax.call([{methodname:"block_poodllclassroom_submit_mform",args:{contextid:this.contextid,jsonformdata:JSON.stringify(formData),formname:this.formname},done:this.handleFormSubmissionResponse.bind(this,formData),fail:this.handleFormSubmissionFailure.bind(this,formData)}])}},TheForm.prototype.submitForm=function(e){e.preventDefault(),this.modal.getRoot().find("form").submit()},{init:function(selector,contextid,formname,callback){return new TheForm(selector,contextid,formname,callback)}}}));

//# sourceMappingURL=modalformhelper.min.js.map